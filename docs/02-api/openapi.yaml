
openapi: 3.0.3
info:
	title: Smart Restaurant API (MVP)
	version: 0.1.0
	description: >-
		Contract-first spec for MVP features: Auth, Tenants, Tables & QR,
		Menu, Orders, Payments, and Public Scan.
servers:
	- url: https://api.smart-restaurant.local/v1
		description: Staging
	- url: http://localhost:4000/v1
		description: Local
tags:
	- name: Auth
	- name: Tenants
	- name: Tables & QR
	- name: Menu
	- name: Orders
	- name: Payments
	- name: Public
paths:
	/auth/login:
		post:
			tags: [Auth]
			summary: Login with email/password
			requestBody:
				required: true
				content:
					application/json:
						schema:
							type: object
							required: [email, password]
							properties:
								email:
									type: string
									format: email
								password:
									type: string
			responses:
				'200':
					description: OK
					content:
						application/json:
							schema:
								type: object
								properties:
									accessToken:
										type: string
									tokenType:
										type: string
										example: Bearer
				'401':
					$ref: '#/components/responses/Unauthorized'

	/tenants:
		post:
			tags: [Tenants]
			summary: Create tenant (signup)
			security: []
			requestBody:
				required: true
				content:
					application/json:
						schema:
							$ref: '#/components/schemas/TenantCreate'
			responses:
				'201':
					description: Created
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/Tenant'
	/tenants/{tenantId}:
		get:
			tags: [Tenants]
			summary: Get tenant by id
			parameters:
				- $ref: '#/components/parameters/TenantId'
			responses:
				'200':
					description: OK
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/Tenant'
				'404':
					$ref: '#/components/responses/NotFound'

	/tenants/{tenantId}/tables:
		post:
			tags: [Tables & QR]
			summary: Create table for tenant
			parameters:
				- $ref: '#/components/parameters/TenantId'
			requestBody:
				required: true
				content:
					application/json:
						schema:
							$ref: '#/components/schemas/TableCreate'
			responses:
				'201':
					description: Created
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/Table'

	/tables/{tableId}/qrcode:
		post:
			tags: [Tables & QR]
			summary: Generate or regenerate QR for a table (increments token version)
			parameters:
				- $ref: '#/components/parameters/TableId'
			responses:
				'200':
					description: OK
					content:
						application/json:
							schema:
								type: object
								properties:
									url:
										type: string
										description: Public scan URL containing signed token
									image:
										type: string
										format: byte
										description: Base64 PNG/SVG

	/public/scan/{token}:
		get:
			tags: [Public]
			summary: Validate scan token and return redirect target or error
			parameters:
				- name: token
					in: path
					required: true
					schema:
						type: string
			responses:
				'200':
					description: Valid token
					content:
						application/json:
							schema:
								type: object
								properties:
									tenantId:
										type: string
									tableId:
										type: string
									redirect:
										type: string
				'410':
					description: Token expired or invalidated

	/tenants/{tenantId}/menu/categories:
		get:
			tags: [Menu]
			summary: List categories
			parameters:
				- $ref: '#/components/parameters/TenantId'
			responses:
				'200':
					description: OK
					content:
						application/json:
							schema:
								type: array
								items:
									$ref: '#/components/schemas/MenuCategory'
		post:
			tags: [Menu]
			summary: Create category
			parameters:
				- $ref: '#/components/parameters/TenantId'
			requestBody:
				required: true
				content:
					application/json:
						schema:
							$ref: '#/components/schemas/MenuCategoryCreate'
			responses:
				'201':
					description: Created
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/MenuCategory'

	/tenants/{tenantId}/menu/items:
		post:
			tags: [Menu]
			summary: Create menu item
			parameters:
				- $ref: '#/components/parameters/TenantId'
			requestBody:
				required: true
				content:
					application/json:
						schema:
							$ref: '#/components/schemas/MenuItemCreate'
			responses:
				'201':
					description: Created
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/MenuItem'

	/orders:
		post:
			tags: [Orders]
			summary: Create order
			requestBody:
				required: true
				content:
					application/json:
						schema:
							$ref: '#/components/schemas/OrderCreate'
			responses:
				'201':
					description: Created
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/Order'

	/orders/{orderId}:
		get:
			tags: [Orders]
			summary: Get order by id
			parameters:
				- $ref: '#/components/parameters/OrderId'
			responses:
				'200':
					description: OK
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/Order'
				'404':
					$ref: '#/components/responses/NotFound'

	/orders/{orderId}/status:
		patch:
			tags: [Orders]
			summary: Update order status (staff flow)
			parameters:
				- $ref: '#/components/parameters/OrderId'
			requestBody:
				required: true
				content:
					application/json:
						schema:
							type: object
							required: [status]
							properties:
								status:
									type: string
									enum: [Received, Preparing, Ready, Completed, Cancelled]
			responses:
				'200':
					description: OK
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/Order'

	/payments/intent:
		post:
			tags: [Payments]
			summary: Create payment intent (card) or mark bill-to-table
			requestBody:
				required: true
				content:
					application/json:
						schema:
							$ref: '#/components/schemas/PaymentIntentCreate'
			responses:
				'201':
					description: Created
					content:
						application/json:
							schema:
								$ref: '#/components/schemas/PaymentIntent'

	/webhooks/payments/stripe:
		post:
			tags: [Payments]
			summary: Stripe webhook (idempotent)
			security: []
			requestBody:
				required: true
				content:
					application/json:
						schema:
							type: object
			responses:
				'200':
					description: OK

components:
	securitySchemes:
		bearerAuth:
			type: http
			scheme: bearer
			bearerFormat: JWT
	parameters:
		TenantId:
			name: tenantId
			in: path
			required: true
			schema:
				type: string
		TableId:
			name: tableId
			in: path
			required: true
			schema:
				type: string
		OrderId:
			name: orderId
			in: path
			required: true
			schema:
				type: string
	responses:
		Unauthorized:
			description: Unauthorized
		NotFound:
			description: Not found
	schemas:
		TenantCreate:
			type: object
			required: [name, email]
			properties:
				name: { type: string }
				email: { type: string, format: email }
				timezone: { type: string }
		Tenant:
			type: object
			properties:
				id: { type: string }
				name: { type: string }
				email: { type: string }
				timezone: { type: string }

		TableCreate:
			type: object
			required: [name, capacity]
			properties:
				name: { type: string }
				capacity: { type: integer }
				location: { type: string }
		Table:
			type: object
			properties:
				id: { type: string }
				tenantId: { type: string }
				name: { type: string }
				capacity: { type: integer }
				location: { type: string }

		MenuCategoryCreate:
			type: object
			required: [name]
			properties:
				name: { type: string }
				description: { type: string }
		MenuCategory:
			type: object
			properties:
				id: { type: string }
				tenantId: { type: string }
				name: { type: string }
				description: { type: string }
		MenuItemCreate:
			type: object
			required: [name, price, categoryId]
			properties:
				name: { type: string }
				description: { type: string }
				imageUrl: { type: string }
				price: { type: number, format: float }
				currency: { type: string, example: VND }
				categoryId: { type: string }
				modifiers:
					type: array
					items:
						$ref: '#/components/schemas/Modifier'
		MenuItem:
			allOf:
				- $ref: '#/components/schemas/MenuItemCreate'
				- type: object
					properties:
						id: { type: string }
						tenantId: { type: string }
		Modifier:
			type: object
			properties:
				name: { type: string }
				type: { type: string, enum: [single, multiple] }
				options:
					type: array
					items:
						type: object
						properties:
							label: { type: string }
							priceDelta: { type: number, format: float }

		OrderCreate:
			type: object
			required: [tenantId, tableId, items]
			properties:
				tenantId: { type: string }
				tableId: { type: string }
				items:
					type: array
					items:
						$ref: '#/components/schemas/OrderItemCreate'
				note: { type: string }
				paymentMethod: { type: string, enum: [card, bill_to_table] }
		OrderItemCreate:
			type: object
			required: [itemId, quantity]
			properties:
				itemId: { type: string }
				quantity: { type: integer, minimum: 1 }
				modifiers:
					type: array
					items:
						type: object
						properties:
							name: { type: string }
							selected: { type: array, items: { type: string } }
		Order:
			type: object
			properties:
				id: { type: string }
				tenantId: { type: string }
				tableId: { type: string }
				status: { type: string, enum: [Draft, Submitted, PaymentPending, PaymentFailed, Received, Preparing, Ready, Completed, Cancelled] }
				items:
					type: array
					items:
						type: object
				total:
					type: number
					format: float
				currency: { type: string, example: VND }

		PaymentIntentCreate:
			type: object
			required: [orderId, method]
			properties:
				orderId: { type: string }
				method: { type: string, enum: [card, bill_to_table] }
		PaymentIntent:
			type: object
			properties:
				id: { type: string }
				orderId: { type: string }
				provider: { type: string, example: stripe }
				clientSecret: { type: string }
				status: { type: string, enum: [requires_payment_method, requires_action, succeeded, canceled] }

security:
	- bearerAuth: []

